---
title: "ASTD data"
---

## Preamble

Protection of the Arctic Marine Environment ([PAME](https://pame.is/)) hosts Arctic Ship Traffic Data ([ASTD](https://pame.is/ourwork/arctic-shipping/current-shipping-projects/astd/)) from 2013 onwards. ASTD Participating Arctic States have full, free, and unfettered access to the ASTD System for research and analysis, while Permanent Participants, Arctic Council Observers, and other eligible entities such as research institutions and universities, may gain access upon request.

The datasource is Automatic Identification System (AIS data) received from ships operating in the Arctic. This data is collected by around 100 satellites and multiple base stations and is provided by USA and Norway. The data is reportedly recorded approximately every 6 minutes and is limited to vessels with class A AIS transponder.

The areal coverage is as follows:

```{r}
library(tidyverse)
library(duckdbfs)
library(sf)
library(ramb)
library(rnaturalearth)
library(rnaturalearthdata)
astd_area <- 
  read_sf(here::here("data/auxillary/ASTD_area.gpkg")) |> 
  st_cast("LINESTRING")
bb <- st_bbox(astd_area)
world <- 
  ne_countries(scale = "medium", returnclass = "sf") |> 
  st_transform(crs = st_crs(astd_area)) |> 
  st_crop(bb)
ggplot() +
  theme_void() +
  geom_sf(data = world, fill = "grey") +
  geom_sf(data = astd_area, colour = "red")
```

An overview of the ping frequency and number of distinct vessels in August 2024 (see below) by every 10 nautical mile grid shows that the the ping frequency and distinct vessel numbers are highest in the northern Baltic, along the Norwegian coast, around Svalbard, Faeroe Islands, Iceland the Northen coast of West Greenland.

```{r}
astd <- 
  nanoparquet::read_parquet(here::here("data/ais/astd/year=2024/month=8/part-0.parquet")) |> 
  collect() |> 
  select(.rid, time, 
         dd = dist_nextpoint,
         dt = sec_nextpoint,
         lon, lat) |> 
  st_as_sf(coords = c("lon", "lat"),
           crs = 4326,
           remove = FALSE) |> 
  st_transform(crs = 3575)
astd <- 
  bind_cols(astd |> st_drop_geometry(),
            st_coordinates(astd) |> 
              as_tibble() |> 
              rename(x = X, y = Y))
dx <- dy <- 10 * 1852
s <-
  astd |> 
  mutate(x = x %/% dx * dx + dx/2,
         y = y %/% dy * dy + dy/2) |> 
  group_by(x, y) |> 
  summarise(n = n(),
            vessels = n_distinct(.rid),
            dt = mean(dt, na.rm = TRUE) / 60,
            .groups = "drop")
p1 <- 
  s |> 
  mutate(dt = ifelse(dt > 60, 60, dt)) |> 
  ggplot() +
  theme_void() +
  geom_tile(aes(x, y, fill = dt)) +
  geom_sf(data = world, fill = "grey") +
  geom_sf(data = astd_area, colour = "red") +
  scale_fill_viridis_c(option = "inferno") +
  labs(fill = "Ping frequency\n[minutes]")
p2 <- 
  s |>
  mutate(vessels = ifelse(vessels > 200, 200, vessels)) |> 
  ggplot() +
  theme_void() +
  geom_tile(aes(x, y, fill = vessels)) +
  geom_sf(data = world, fill = "grey") +
  geom_sf(data = astd_area, colour = "red") +
  scale_fill_viridis_c(option = "inferno", direction = -1) +
  labs(fill = "Distinct\nvessels")
library(patchwork)
p1 + p2
```




```{r}
#| eval: false
## Summary overview
astd <- open_dataset(here::here("data/ais/astd"))
astd |> glimpse()
astd |> count()
dt <- 
  astd |> 
  group_by(datem) |> 
  summarise(n = n(),
            dt = mean(sec_nextpoint, na.rm = TRUE),
            .groups = "drop") |> 
  collect()
dt |> 
  ggplot(aes(datem, dt)) +
  geom_point()
dt <- 
  astd |> 
  group_by(datem, eez) |> 
  summarise(n = n(),
            dt = mean(sec_nextpoint, na.rm = TRUE),
            .groups = "drop") |> 
  collect()

dt |> 
  arrange(-n)
dt |> 
  filter(datem >= ymd("2015-01-01"),
         eez %in% c("NOR", "ISL")) |>  #, "Sildarsmugan", "Smugan", "Atlantic")) |> 
  ggplot(aes(datem, dt / 60, colour = eez)) +
  geom_point() +
  scale_colour_brewer(palette = "Set1")
dt |> 
  mutate(year = year(datem)) |> 
  reframe(n = sum(n),
          .by = year) |> 
  ggplot(aes(year, n)) +
  geom_point()

dx <- 0.05
dy <- dx / 2
g <- 
  astd |> 
  filter(year == 2024) |> 
  mutate(x = lon %/% dx * dx + dx/2,
         y = lat %/% dy * dy + dy/2) |> 
  group_by(x, y) |> 
  summarise(n = n(),
            dt = mean(sec_nextpoint, na.rm = TRUE),
            .groups = "drop") |> 
  collect()
g |> 
  filter(between(x, -65, 60),
         between(y, 58, 83)) |> 
  mutate(dt = dt / 60,
         dt = ifelse(dt > 60, 60, dt)) |> 
  ggplot(aes(x, y, fill = log10(n))) +
  geom_tile() +
  scale_fill_viridis_c(option = "inferno") +
  coord_quickmap() +
  labs(x = NULL, y = NULL)
```

## Under the hood

```{r}
open_dataset(here::here("data/ais/astd")) |> 
  select(.rid:sizegroup_gt, 
         dd = dist_nextpoint,
         dt = sec_nextpoint,
         lon, lat, eez,
         datem, month, year) |> 
  filter(eez == "GRL") |> 
  collect() ->
  grl
dx <- 1
dy <- dx / 2
g <- 
  grl |> 
  mutate(x = lon %/% dx * dx + dx/2,
         y = lat %/% dy * dy + dy/2) |> 
  group_by(year, x, y) |> 
  reframe(n = n_distinct(.rid, mmsi, imonumber, vessel, month),
          dt = mean(dt, na.rm = TRUE) / 60)
g |> 
  mutate(n = ifelse(n > 100, 100, n),
         dt = ifelse(dt > 60, 60, dt)) |> 
  filter(dt > 0,
         year == 2024) |> 
  ggplot(aes(x, y, fill = dt)) +
  geom_tile() +
  scale_fill_viridis_c(option = "inferno", direction = +1) +
  facet_wrap(~ year) +
  coord_quickmap()
```

